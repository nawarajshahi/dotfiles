#!/usr/bin/env ruby

require 'net/https'
require 'resolv'

def get_record(type)
  resolver = Resolv::DNS.new(nameserver: %w(1.1.1.1 1.0.0.1))
  responses = resolver.getresources('ip.stelfox.net', type)
  responses.sample.address.to_s
end

def request_ip(server_ip)
  ip_addr_url = URI.parse('https://ip.stelfox.net/')
  response = Net::HTTP.start(ip_addr_url.host, ip_addr_url.port, use_ssl: true, ipaddr: server_ip) do |http|
    request = Net::HTTP::Get.new(ip_addr_url)
    http.request(request)
  end

  if response.code_type != Net::HTTPOK
    puts 'An error occurred while attempting to find the true external IP address'
    exit 1
  end

  response.body
end

ipv4 = request_ip(get_record(Resolv::DNS::Resource::IN::A))
ipv6 = request_ip(get_record(Resolv::DNS::Resource::IN::AAAA))

puts "IPv4: #{ipv4}"
puts "IPv6: #{ipv6}"
